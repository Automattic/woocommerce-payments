name: "Build zip file"

# This action will run when it is triggered manually.
on:
  workflow_dispatch:
    inputs:
      skip_smoke_tests:
        type: boolean
        description: Skip running smoke tests

jobs:
  build-zip:
    name: "Build the zip file"
    runs-on: ubuntu-20.04
    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v3

      - name: "Set up repository"
        uses: ./.github/actions/setup-repo

      - name: "Build the plugin"
        id: build_plugin
        uses: ./.github/actions/build

      - name: "Delete the zip file created by build script"
        run: |
          echo ":information_source: Please ignore the artifact size mentioned. GitHub calculates the size of the source folder instead of the zip file created." >> $GITHUB_STEP_SUMMARY
          rm -rf release/${{ steps.build_plugin.outputs.release-filename }}

      - name: "Upload the zip file as an artifact"
        uses: actions/upload-artifact@v3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          name: "woocommerce-payments"
          path: release
          retention-days: 7

  smoke-tests:
    runs-on: ubuntu-20.04
    if: ${{ ! inputs.skip_smoke_tests }}
    needs: build-zip

    strategy:
      fail-fast:     false
      matrix:
        test_groups:   [ 'wcpay', 'subscriptions' ] # [TODO] Unskip blocks tests after investigating constant failures.
        test_branches: [ 'merchant', 'shopper' ]

    name: WC - latest | ${{ matrix.test_groups }} - ${{ matrix.test_branches }}

    env:
      E2E_GH_TOKEN:          ${{ secrets.E2E_GH_TOKEN }}
      WCP_DEV_TOOLS_REPO:    ${{ secrets.WCP_DEV_TOOLS_REPO }}
      WCP_DEV_TOOLS_BRANCH:  'trunk'
      WCP_SERVER_REPO:       ${{ secrets.WCP_SERVER_REPO }}
      WC_SUBSCRIPTIONS_REPO: ${{ secrets.WC_SUBSCRIPTIONS_REPO }}
      E2E_BLOG_ID:           ${{ secrets.E2E_BLOG_ID }}
      E2E_BLOG_TOKEN:        ${{ secrets.E2E_BLOG_TOKEN }}
      E2E_USER_TOKEN:        ${{ secrets.E2E_USER_TOKEN }}
      WC_E2E_SCREENSHOTS:    1
      E2E_SLACK_CHANNEL:     ${{ secrets.E2E_SLACK_CHANNEL }}
      E2E_SLACK_TOKEN:       ${{ secrets.E2E_SLACK_TOKEN }}
      E2E_USE_LOCAL_SERVER:  false
      E2E_RESULT_FILEPATH:   'tests/e2e/results.json'
      E2E_WP_VERSION:        'latest'
      E2E_WC_VERSION:        'latest'
      E2E_GROUP:             ${{ matrix.test_groups }}
      E2E_BRANCH:            ${{ matrix.test_branches }}
      SKIP_BUILD_STEP:       true

    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v3

      - name: "Download WooCommerce Payments build file"
        uses: actions/download-artifact@v3
        with:
          name: woocommerce-payments

      - name: "Zip the downloaded artifact"
        shell: bash
        run: |
          mv woocommerce-payments/woocommerce-payments woocommerce-payments/woocommerce-payments-build
          zip -r woocommerce-payments-build.zip woocommerce-payments
          rm -rf woocommerce-payments
          echo "PLUGIN_FILE_PATH=./woocommerce-payments-build.zip" >> $GITHUB_ENV

      # - name: Setup E2E environment
      #   uses: ./.github/actions/e2e/env-setup

      # - name: Run tests, upload screenshots & logs
      #   uses: ./.github/actions/e2e/run-log-tests

      - name: Archive e2e test screenshots & logs
        uses: actions/upload-artifact@v3
        with:
            name: wc-payments-build
            path: woocommerce-payments-build.zip
            if-no-files-found: ignore
            retention-days: 14
