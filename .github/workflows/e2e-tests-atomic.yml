name: "E2E Tests on Atomic - All"

# This action will run when it is triggered manually or on Pull Request with base=trunk
on:
  pull_request:
    branches:
      - trunk
  workflow_dispatch:

env:
  WC_E2E_SCREENSHOTS: 1
  E2E_SLACK_CHANNEL: ${{ secrets.E2E_SLACK_CHANNEL }}
  E2E_SLACK_TOKEN: ${{ secrets.E2E_SLACK_TOKEN }}
  E2E_WP_VERSION: 'nightly'
  E2E_WC_VERSION: 'latest'
  E2E_RESULT_FILEPATH: 'tests/e2e/results.json'
  NODE_ENV: 'atomic'

jobs:
  # Run tests against WP Nightly & WC latest. Not UPE ones to avoid impacting the other tests with UPE enabled.
  wp-nightly-tests-first-batch:
    name: "WP - ${{ env.E2E_WP_VERSION }} | WC - ${{ env.E2E_WC_VERSION }} | ${{ env.E2E_GROUP }} - ${{ env.E2E_BRANCH }}"
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        test_groups: [ 'wcpay', 'subscriptions' ]
        test_branches: [ 'merchant', 'shopper' ]
        exclude:
          - test_groups: 'subscriptions'
    env:
      E2E_GROUP: ${{ matrix.test_groups }}
      E2E_BRANCH: ${{ matrix.test_branches }}
    
    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v3

      - name: "Run the tests"
        uses: ./.github/actions/e2e/atomic-prepare-and-run
  
  # Run UPE tests against WP Nightly & WC latest.
  wp-nightly-tests-upe:
    name: "WP - ${{ env.E2E_WP_VERSION }} | WC - ${{ env.E2E_WC_VERSION }} | ${{ env.E2E_GROUP }} - ${{ env.E2E_BRANCH }}"
    runs-on: ubuntu-22.04
    needs: wp-nightly-tests-first-batch
    if: always()
    env:
      E2E_GROUP: 'upe'
      E2E_BRANCH: 'shopper'

    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v3

      - name: "Run the tests"
        uses: ./.github/actions/e2e/atomic-prepare-and-run
  
  # Run UPE tests against WP Nightly & WC latest.
  wp-nightly-tests-upe-split:
    name: "WP - ${{ env.E2E_WP_VERSION }} | WC - ${{ env.E2E_WC_VERSION }} | ${{ env.E2E_GROUP }} - ${{ env.E2E_BRANCH }}"
    runs-on: ubuntu-22.04
    needs: wp-nightly-tests-upe
    if: always()
    env:
      E2E_GROUP: 'upeSplit'
      E2E_BRANCH: 'shopper'

    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v3

      - name: "Run the tests"
        uses: ./.github/actions/e2e/atomic-prepare-and-run 
