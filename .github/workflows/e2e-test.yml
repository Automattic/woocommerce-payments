name: E2E tests

on:
  pull_request:
    branches:
      - master

env:
  WP_VERSION:         latest
  WC_VERSION:         4.5.0  # the most used version here
  CI_USER_TOKEN:      ${{ secrets.CI_USER_TOKEN }}      # TODO: replace with one from CI-user
  WCP_DEV_TOOLS_REPO: ${{ secrets.WCP_DEV_TOOLS_REPO }}
  WCP_SERVER_REPO:    ${{ secrets.WCP_SERVER_REPO }}

jobs:
  e2e:
    name:    E2E tests
    runs-on: ubuntu-latest      

    steps:
      # clone the repository
      - uses: actions/checkout@v2
      # setup PHP, but without debug extensions for reasonable performance
      - uses: shivammathur/setup-php@v2
        with:
          php-version: 7.4
          tools:       composer
          extensions:  mysql
          coverage:    none
      # install dependencies
      - run: composer self-update 2.0.6 && composer install --no-progress
      - run: npm ci && npm run build:client
      # prepare testing resources and run E2E tests
      - run: echo -e "machine github.com\n  login $CI_USER_TOKEN" > ~/.netrc
      - run: sudo systemctl start mysql.service
      - run: WCPAY_DIR="$GITHUB_WORKSPACE" bash ./bin/install-wp-tests.sh woocommerce_test root root localhost $WP_VERSION $WC_VERSION false
      - run: COMPOSE_INTERACTIVE_NO_CLI=1 npm run test:e2e-setup && npm run test:e2e
