name: Build live branch for PR

on:
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
env:
  # Only need to retain for a day since the Jetpack beta builder slurps it up to distribute.
  WCPAY_LIVE_BRANCH_ARTIFACT_RETENTION_DAYS: 1
jobs:
  build-and-upload-zip-file:
    name: "Build and inform the zip file"
    runs-on: ubuntu-20.04
    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v3

      - name: "Get current version"
        id: current-version
        run: |
          VERSION=$(jq '.version' package.json -r)
          echo "Current version found: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: "Set up repository"
        uses: ./.github/actions/setup-repo

      - name: "Calculate the next version"
        id: next-version
        env:
          RELEASE_VERSION: ${{ steps.current-version.outputs.VERSION }}
        run: php .github/workflows/scripts/get-next-version.php # outputs.NEXT_RELEASE_VERSION

      - name: "Bump dev version"
        id: bump-dev-version
        env: 
          NEXT_VERSION: ${{ steps.next-version.outputs.NEXT_RELEASE_VERSION }}
          PR: ${{ github.event.number }}
        run: |
          CURRENT_VERSION=$(jq '.version' package.json -r)
          DEV_SUFFIX_VERSION="dev_PR-${PR}_commit-$(git rev-parse --short HEAD)"
          DEV_VERSION="${NEXT_VERSION}-${DEV_SUFFIX_VERSION}"
          echo "Dev Version: $DEV_VERSION" >> $GITHUB_STEP_SUMMARY

          # Plugin data is passed as a JSON object.
          PLUGIN_DATA="{}"          
          PLUGIN_DATA=$( jq -c --arg slug "woocommerce-payments" --arg ver "$DEV_VERSION" '.[ $slug ] = { version: $ver }' <<<"$PLUGIN_DATA" )
          echo "plugin-data=$PLUGIN_DATA" >> $GITHUB_OUTPUT

          # 'Version' header in woocommerce-payments.php
          sed -i "s/^ \* Version: .*$/ * Version: $DEV_VERSION/" woocommerce-payments.php

          # 'version' field in package.json
          sed -ri 's/("version": )".*"/\1"'${DEV_VERSION}'"/' package.json

          # 'Stable tag' header in readme.txt;
          sed -i "s/^Stable tag: .*$/Stable tag: $DEV_VERSION/" readme.txt

      - name: "Build the plugin"
        id: build_plugin
        uses: ./.github/actions/build

      - name: "Update the structure of artifacts for Jetpack Beta Builder" 
        run: |
          cd release
          mv woocommerce-payments woocommerce-payments-dev
          zip -q -r "woocommerce-payments-dev.zip" "woocommerce-payments-dev/"
          rm -fR "woocommerce-payments-dev"

      - name: "Add file size notice"
        run: |
          echo ":information_source: Ignore the artifact size mentioned since GitHub calculates the size of the source folder instead of the zip file created." >> $GITHUB_STEP_SUMMARY

      - name: "Upload the zip file as an artifact"
        uses: actions/upload-artifact@v3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          name: plugins # Hard-coded value for Jetpack Beta Builder.
          path: release
          retention-days: ${{ env.WCPAY_LIVE_BRANCH_ARTIFACT_RETENTION_DAYS }}

      - name: Inform Beta Download webhook
        if: steps.bump-dev-version.outputs.plugin-data != '{}'
        env:
          SECRET: ${{ secrets.WCPAYBETA_SECRET }}
          PLUGIN_DATA: ${{ steps.bump-dev-version.outputs.plugin-data }}
          PR: ${{ github.event.number }}
        run: |
          curl -v --fail -L \
            --url "https://betadownload.jetpack.me/gh-action.php?run_id=$GITHUB_RUN_ID&pr=$PR&commit=$GITHUB_SHA" \
            --form-string "repo=$GITHUB_REPOSITORY" \
            --form-string "branch=${GITHUB_REF#refs/heads/}" \
            --form-string "plugins=$PLUGIN_DATA" \
            --form-string "secret=$SECRET"

      - name: "Add/update the information as a comment in the PR"
        env:
          GITHUB_TOKEN: ${{ secrets.BOTWOO_TOKEN }}
          PR_NUMBER: ${{ github.event.number }}
          ARTIFACT_RETENTION_DAY: ${{ env.WCPAY_LIVE_BRANCH_ARTIFACT_RETENTION_DAYS }}
        run: |
          EXPIRY_TIME=$(date -u "+%Y-%m-%d %H:%M:%S UTC" -d "+${ARTIFACT_RETENTION_DAY} day")
          
          BODY="### Grab the build file for this PR
          
          :x: This build file is NOT ready for production. It's available for testing only.

          - Latest commit: ${GITHUB_SHA}
          - Build file in the 'Artifacts' section: https://github.com/Automattic/woocommerce-payments/actions/runs/${GITHUB_RUN_ID}
          - Expired at: ${EXPIRY_TIME}

          _Note: this comment is updated when a new commit is pushed to this PR._"

          PR_URL="https://github.com/Automattic/woocommerce-payments/pull/${PR_NUMBER}"

          # Try to update the last comment first. If not work, just create a new comment.
          if ! gh pr comment ${PR_URL} --body "${BODY}" --edit-last
          then
            gh pr comment ${PR_URL} --body "${BODY}"
          fi
