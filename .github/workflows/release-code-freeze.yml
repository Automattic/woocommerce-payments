name: "Release: code freeze"
on:
  schedule:
    - cron: '0 12 * * 0' # Run at 1200 UTC on Sundays.
  workflow_dispatch:
    inputs:
      skipSlackPing:
        description: "If true, the Slack ping will be skipped (useful for testing)"
        type: boolean
        required: false
        default: false
      slackChannel:
        description: "The channel ID used to send a Slack ping about the code freeze"
        type: string
        required: false

defaults:
  run:
    shell: bash

jobs:
  check-code-freeze:
    name: "Check that today is the day of the code freeze"
    runs-on: ubuntu-20.04
    outputs:
      freeze: ${{ steps.check-freeze.outputs.FREEZE }}
      releaseVersion: ${{ steps.next-version.outputs.RELEASE_VERSION }}
      releaseDate: ${{ steps.next-version.outputs.RELEASE_PLANNED_DATE }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
#        with:
#          ref: 'develop'
    
      - name: Get current version
        id: current-version
        run: |
          VERSION=$(jq '.version' package.json -r)
          echo "::warning::Current version found: $VERSION"
          echo ::set-output name=VERSION::$VERSION
          
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'
          tools: composer
          coverage: none

      - name: Get the next version
        id: next-version
        shell: php {0}
        env:
          CURRENT_VERSION: ${{ steps.current-version.outputs.VERSION }}
        run: |
          <?php
          
          $latest_version_with_release = getenv( 'CURRENT_VERSION' );
          if ( empty( $latest_version_with_release ) ) {
            echo "::error::Unable to get the latest released version";
            exit( 1 );
          }
          
          // Because we go from 5.9 to 6.0, we can get the next major_minor by adding 0.1 and formatting appropriately.
          $latest_version_as_float = (float) $latest_version_with_release;
          $branch_major_minor      = number_format( $latest_version_as_float + 0.1, 1 );
          echo "::set-output name=RELEASE_VERSION::$branch_major_minor.0" . PHP_EOL;;
          
          $next_wednesday = date('Y-n-d', strtotime('next Wednesday'));
          echo "::set-output name=RELEASE_PLANNED_DATE::$next_wednesday" . PHP_EOL;;
          
      - name: Check if the next version needs a code freeze
        id: check-freeze
        env:
          NEXT_VERSION: ${{ steps.next-version.outputs.RELEASE_VERSION }}
        run: |
          echo "Next version: ${{ env.NEXT_VERSION }}"
          git fetch --tags origin
          NEXT_VERSION_TAG_STABLE=$(git tag -l "${{ env.NEXT_VERSION }}" | tail -1)
          NEXT_VERSION_TAG_FROM_WEEK_2=$(git tag -l "${{ env.NEXT_VERSION }}-test-2" | tail -1)
          echo "NEXT_VERSION_TAG_FROM_WEEK_2: $NEXT_VERSION_TAG_FROM_WEEK_2"
          if [[ -z "$NEXT_VERSION_TAG_FROM_WEEK_2" ]]; then
            echo "::warning::Code freeze is not needed"
            echo ::set-output name=FREEZE::0
          elif [[ -z "$NEXT_VERSION_TAG_STABLE" ]]; then
            echo "::warning::Code freeze is needed"
            echo ::set-output name=FREEZE::1
          fi

  prepare-stable-release:
    name: "Raise a PR to trunk for the next stable release"
    needs: check-code-freeze
    if: needs.check-code-freeze.outputs.freeze == 1
    uses: ./.github/workflows/prepare-release.yml
    with:
      tagName: ${{ needs.check-code-freeze.outputs.releaseVersion }}

  slack-notification:
    name: "Send code freeze notification to Slack"
    needs: [check-code-freeze, prepare-stable-release]
    if: ${{ inputs.skipSlackPing != true }}
    runs-on: ubuntu-20.04
    env:
      RELEASE_VERSION: ${{ needs.check-code-freeze.outputs.releaseVersion }}
      RELEASE_DATE: ${{ needs.check-code-freeze.outputs.releaseDate }}
      GITHUB_RELEASE_URL: ${{ format( '{0}/{1}/pull/{2}', github.server_url, github.repository, needs.check-code-freeze.outputs.releaseVersion ) }}
      BRANCH_NAME: ${{ needs.prepare-stable-release.outputs.branch }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Get pull request number
        id: pr_number
        run: |
          PR_NUMBER=$( gh pr view "${{ env.BRANCH_NAME }}/${{ env.RELEASE_VERSION }}" --json number -q .number || echo "" )
          echo ::set-output name=PR_NUMBER::$PR_NUMBER
          
      - name: Slack ping
        uses: slackapi/slack-github-action@v1.18.0
        env:
          GITHUB_RELEASE_URL: ${{ format( '{0}/{1}/pull/{2}', github.server_url, github.repository, steps.pr_number.outputs.PR_NUMBER ) }}
          SLACK_WEBHOOK_URL: ${{ secrets.CODE_FREEZE_SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        with:
          # For posting a rich message using Block Kit (https://api.slack.com/messaging/interactivity)
          payload: |       
            {
                "blocks": [
                    {
                        "type": "header",
                        "text": {
                            "type": "plain_text",
                            "text": "Code freeze notification",
                            "emoji": true
                        }
                    },
                    {
                        "type": "section",
                        "text": {
                          "type": "mrkdwn",
                          "text": "The automated workflow just created a release branch and raised a Pull Request to merge changes on trunk. Any PRs that were not already merged will be a part of the release after that by default.\n If you have something that needs to be released in ${{ env.RELEASE_VERSION }}, please consult the release lead."
                        }
                    },
                    {
                        "type": "section",
                        "fields": [
                            {
                                "type": "mrkdwn",
                                "text": "*Version:*\n<${{ env.GITHUB_RELEASE_URL }}|${{ env.RELEASE_VERSION }}>"
                            },
                            {
                                "type": "mrkdwn",
                                "text": "*Planned date:*\n<https://wcpay.wordpress.com/dev-resources/wc-payments-release-calendar/|${{ env.RELEASE_DATE }}>"
                            }
                        ]
                    }
                ]
            }
